{"ast":null,"code":"\"use strict\";\n\nvar _interopRequireDefault = require(\"@babel/runtime/helpers/interopRequireDefault\");\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.locks = locks;\n\nvar _bn = _interopRequireDefault(require(\"bn.js\"));\n\nvar _rxjs = require(\"rxjs\");\n\nvar _operators = require(\"rxjs/operators\");\n\nvar _util = require(\"@polkadot/util\");\n\nvar _util2 = require(\"../util\"); // Copyright 2017-2020 @polkadot/api-derive authors & contributors\n// This software may be modified and distributed under the terms\n// of the Apache-2.0 license. See the LICENSE file for details.\n\n\nconst LOCKUPS = [0, 1, 2, 4, 8, 16, 32];\nconst ZERO = new _bn.default(0);\n\nfunction parseLock(api, [referendumId, accountVote], referendum) {\n  const {\n    balance,\n    vote\n  } = accountVote.asStandard;\n  let unlockAt = ZERO;\n\n  if (referendum.isFinished) {\n    const {\n      approved,\n      end\n    } = referendum.asFinished;\n\n    if (approved.isTrue && vote.isAye || approved.isFalse && vote.isNay) {\n      unlockAt = end.add(api.consts.democracy.enactmentPeriod.muln(LOCKUPS[vote.conviction.index]));\n    }\n  }\n\n  return {\n    balance,\n    isFinished: referendum.isFinished,\n    referendumId,\n    unlockAt,\n    vote\n  };\n}\n\nfunction directLocks(api, {\n  votes\n}) {\n  if (!votes.length) {\n    return (0, _rxjs.of)([]);\n  }\n\n  return api.query.democracy.referendumInfoOf.multi(votes.map(([referendumId]) => referendumId)).pipe((0, _operators.map)(referendums => votes.map((vote, index) => [vote, referendums[index].unwrapOr(null)]).filter(item => !!item[1] && (0, _util.isUndefined)(item[1].end) && item[0][1].isStandard).map(([directVote, referendum]) => parseLock(api, directVote, referendum))));\n}\n\nfunction locks(api) {\n  return (0, _util2.memo)(accountId => api.query.democracy.votingOf(accountId).pipe((0, _operators.switchMap)(voting => voting.isDirect ? directLocks(api, voting.asDirect) : (0, _rxjs.of)([]))));\n}","map":null,"metadata":{},"sourceType":"script"}